name: Build APK
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android Project Structure
        run: |
          # Folder များ ဆောက်ခြင်း
          mkdir -p app/src/main/java/com/my/ayra
          mkdir -p app/src/main/res/layout
          
          # Gradle Wrapper နှင့် အခြေခံဖိုင်များ ထည့်သွင်းခြင်း
          gradle wrapper --gradle-version 8.4

          # Root build.gradle
          cat <<EOF > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:8.2.0' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          # settings.gradle
          echo "include ':app'" > settings.gradle

          # app/build.gradle
          cat <<EOF > app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.my.ayra'
              compileSdk 34
              defaultConfig {
                  applicationId "com.my.ayra"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
          }
          EOF

          # AndroidManifest.xml
          cat <<EOF > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="Ayra AI">
                  <activity android:name="com.my.ayra.MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # Layout (main.xml)
          cat <<'EOF' > app/src/main/res/layout/main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="match_parent" android:layout_height="match_parent" android:orientation="vertical" android:background="#121212">
              <ScrollView android:id="@+id/scrollView" android:layout_width="match_parent" android:layout_height="0dp" android:layout_weight="1"><LinearLayout android:id="@+id/chatContainer" android:layout_width="match_parent" android:layout_height="wrap_content" android:orientation="vertical" android:padding="10dp" /></ScrollView>
              <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content" android:orientation="horizontal" android:padding="10dp" android:background="#1E1E1E">
                  <EditText android:id="@+id/userInput" android:layout_width="0dp" android:layout_height="wrap_content" android:layout_weight="1" android:hint="Ask Ayra AI..." android:textColor="#FFFFFF" android:background="@android:color/transparent" />
                  <TextView android:id="@+id/sendBtn" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="SEND" android:textColor="#1A73E8" android:textStyle="bold" android:padding="10dp" />
              </LinearLayout>
          </LinearLayout>
          EOF

          # Java Code (MainActivity.java)
          cat <<'EOF' > app/src/main/java/com/my/ayra/MainActivity.java
          package com.my.ayra;
          import android.app.Activity;
          import android.os.*;
          import android.view.*;
          import android.widget.*;
          import android.graphics.Color;
          import android.graphics.drawable.GradientDrawable;
          import java.io.*;
          import java.net.*;
          import org.json.*;
          public class MainActivity extends Activity {
              private LinearLayout chatContainer;
              private ScrollView scrollView;
              private EditText userInput;
              private Handler handler = new Handler();
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(getResources().getIdentifier("main", "layout", getPackageName()));
                  chatContainer = findViewById(getResources().getIdentifier("chatContainer", "id", getPackageName()));
                  scrollView = findViewById(getResources().getIdentifier("scrollView", "id", getPackageName()));
                  userInput = findViewById(getResources().getIdentifier("userInput", "id", getPackageName()));
                  TextView sendBtn = findViewById(getResources().getIdentifier("sendBtn", "id", getPackageName()));
                  sendBtn.setOnClickListener(v -> {
                      String text = userInput.getText().toString().trim();
                      if (!text.isEmpty()) { 
                          addChatBubble(text, true); 
                          userInput.setText(""); 
                          new Thread(() -> { 
                              String result = getAyraResponse(text); 
                              handler.post(() -> addChatBubble("Ayra: " + result, false)); 
                          }).start(); 
                      }
                  });
              }
              private String getAyraResponse(String msg) {
                  try {
                      URL url = new URL("https://open-ai-api-production.up.railway.app/v1/chat/completions");
                      HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                      conn.setRequestMethod("POST");
                      conn.setRequestProperty("Content-Type", "application/json");
                      conn.setDoOutput(true);
                      JSONObject body = new JSONObject();
                      body.put("model", "gpt-3.5-turbo");
                      JSONArray messages = new JSONArray();
                      messages.put(new JSONObject().put("role", "user").put("content", msg));
                      body.put("messages", messages);
                      OutputStream os = conn.getOutputStream();
                      os.write(body.toString().getBytes());
                      BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                      StringBuilder sb = new StringBuilder(); String line;
                      while ((line = br.readLine()) != null) sb.append(line);
                      return new JSONObject(sb.toString()).getJSONArray("choices").getJSONObject(0).getJSONObject("message").getString("content");
                  } catch (Exception e) { return "Connection Error!"; }
              }
              private TextView addChatBubble(String text, boolean isUser) {
                  TextView tv = new TextView(this); tv.setText(text); tv.setPadding(40, 30, 40, 30); tv.setTextColor(Color.WHITE);
                  LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(-2, -2); params.setMargins(0, 15, 0, 15);
                  GradientDrawable gd = new GradientDrawable(); gd.setCornerRadius(55);
                  if (isUser) { params.gravity = Gravity.END; gd.setColor(Color.parseColor("#262626")); }
                  else { params.gravity = Gravity.START; gd.setColor(Color.parseColor("#004A99")); }
                  tv.setBackground(gd); tv.setLayoutParams(params); chatContainer.addView(tv); return tv;
              }
          }
          EOF

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AyraAI-Debug-APK
          path: app/build/outputs/apk/debug/*.apk
          
